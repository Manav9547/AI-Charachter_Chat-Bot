
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Chat Characters</h1>
            </div>
            <div class="sidebar-content">
                <div class="character-group">
                    <div class="character-images">
                        <div class="character-item">
                            <img src="/static/victor.jpeg" alt="Viktor Graves" class="character-image" data-character="victor">
                            <span class="character-name">Viktor Graves</span>
                        </div>
                        <div class="character-item">
                            <img src="/static/jax.jpeg" alt="Jax Carter" class="character-image" data-character="jax">
                            <span class="character-name">Jax Carter</span>
                        </div>
                        <div class="character-item">
                            <img src="/static/elias.jpeg" alt="Elias Sterling" class="character-image" data-character="elias">
                            <span class="character-name">Elias Sterling</span>
                        </div>
                        <div class="character-item">
                            <img src="/static/lila.jpeg" alt="Lila Moreau" class="character-image" data-character="lila">
                            <span class="character-name">Lila Moreau</span>
                        </div>
                    </div>
                </div>
                <div class="selector-group">
                    <label for="languageSelect">Language:</label>
                    <select id="languageSelect">
                        <option value="en-US">English</option>
                        <option value="hi-IN">Hindi</option>
                        <option value="ta-IN">Tamil</option>
                        <option value="kn-IN">Kannada</option>
                        <option value="te-IN">Telugu</option>
                        <option value="ml-IN">Malayalam</option>
                        <option value="bn-IN">Bengali</option>
                        <option value="mr-IN">Marathi</option>
                        <option value="gu-IN">Gujarati</option>
                        <option value="pa-IN">Punjabi</option>
                        <option value="ur-IN">Urdu</option>
                        <option value="ja-JP">Japanese</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="es-ES">Spanish</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="chat-header">
                <h1>Chat with Characters</h1>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="character-showcase" id="characterShowcase">
                    <div class="character-display" data-character="jax">
                        <img src="/static/jax.jpeg" alt="Jax Carter" class="showcase-image">
                        <div class="character-info">
                            <h2>Jax "Wildcard" Carter – The Funny One</h2>
                            <p>A former stand-up comedian turned professional internet troll. He never takes anything seriously and roasts everyone, including you. Despite his chaotic nature, his advice is surprisingly useful—when he feels like giving it.</p>
                        </div>
                    </div>
                    <div class="character-display" data-character="victor">
                        <img src="/static/victor.jpeg" alt="Viktor Graves" class="showcase-image">
                        <div class="character-info">
                            <h2>Viktor Graves – The Rude One</h2>
                            <p>A no-nonsense ex-military strategist who thinks everyone around him is an idiot. He’s brutally honest, sarcastic, and impatient but delivers some of the most effective, no-BS advice—if you can handle the insults.</p>
                        </div>
                    </div>
                    <div class="character-display" data-character="lila">
                        <img src="/static/lila.jpeg" alt="Lila Moreau" class="showcase-image">
                        <div class="character-info">
                            <h2>Lila Moreau – The Flirt</h2>
                            <p>A smooth-talking ex-private investigator who loves to tease and charm. Every conversation is a game to her, and she enjoys keeping you on your toes with playful flirtation while subtly guiding you toward the right answer.</p>
                        </div>
                    </div>
                    <div class="character-display" data-character="elias">
                        <img src="/static/elias.jpeg" alt="Elias Sterling" class="showcase-image">
                        <div class="character-info">
                            <h2>Elias Sterling – The Helpful Mentor</h2>
                            <p>A former professor who left academia to seek real wisdom. He’s calm, insightful, and asks thought-provoking questions that make you think deeply about your choices. A bit mysterious but always kind.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-input">
                <button id="recordButton"><img src="/static/mic_button.png" alt="Record" class="button-icon"></button>
                <input type="text" id="textInput" placeholder="Type your message...">
                <button id="sendButton"><img src="/static/send_button.png" alt="Send" class="button-icon"></button>
            </div>
            <div id="error" style="display: none; color: red;"></div>
        </div>
    </div>

    <script>
        const initialConversation = {{ conversation|tojson|safe }};
        let selectedCharacter = 'victor'; // Default character

        function updateShowcase() {
            const showcase = document.getElementById('characterShowcase');
            const displays = showcase.querySelectorAll('.character-display');
            displays.forEach(display => {
                display.style.display = display.getAttribute('data-character') === selectedCharacter ? 'flex' : 'none';
            });
        }

        function addMessage(content, isUser, character = selectedCharacter, audioUrl = null) {
            const showcase = document.getElementById('characterShowcase');
            showcase.style.display = 'none'; // Hide showcase when chat starts

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', isUser ? 'user' : 'character');
            messageDiv.style.opacity = '0'; // Start hidden for fade-in

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            if (!isUser) {
                messageContent.classList.add(character);
                messageContent.textContent = `${character.charAt(0).toUpperCase() + character.slice(1)}: ${content}`;
            } else {
                messageContent.textContent = content;
            }

            if (audioUrl) {
                const audioContainer = document.createElement('div');
                audioContainer.classList.add('audio-container');

                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl + '?t=' + new Date().getTime(); // Prevent caching
                audio.autoplay = !isUser; // Auto-play character response only

                audioContainer.appendChild(audio);
                messageContent.appendChild(audioContainer);
            }

            messageDiv.appendChild(messageContent);
            document.getElementById('chatMessages').appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s ease';
                messageDiv.style.opacity = '1';
            }, 10);

            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        // Load initial conversation history
        if (initialConversation.length === 0) {
            updateShowcase(); // Show showcase if no messages
        } else {
            document.getElementById('characterShowcase').style.display = 'none'; // Hide showcase if there are messages
            initialConversation.forEach(conv => {
                addMessage(conv.user_input, true, conv.character, conv.recorded_audio_url);
                addMessage(conv.response, false, conv.character, conv.synthesized_audio_url);
            });
        }

        // Handle character selection via images
        document.querySelectorAll('.character-image').forEach(img => {
            img.addEventListener('click', () => {
                document.querySelectorAll('.character-image').forEach(i => i.classList.remove('selected'));
                img.classList.add('selected');
                selectedCharacter = img.getAttribute('data-character');
                document.getElementById('error').textContent = `Character switched to ${img.nextElementSibling.textContent}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').style.color = 'green';
                setTimeout(() => {
                    document.getElementById('error').style.display = 'none';
                }, 3000);
                if (document.getElementById('chatMessages').children.length === 1) { // Only showcase present
                    updateShowcase();
                }
            });
        });
    </script>

    <script src="/static/script.js"></script>
</body>
</html>